<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Deep Analysis of Emotet Banking Trojan (TA542 APT) - ezi0x00</title>
<meta name="description" content="Emotet iss a banking Trojan designed to steal financial information from online banking sessions through man-in-the-browser (MITB) attacks, but since 2017 it has been observed distributing other malware families, such as IcedID, Zeus Panda and TrickBot. The malware has been actively developed, with each new version changing or extending its capabilities. ">


  <meta name="author" content="Omar Mohamed">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="ezi0x00">
<meta property="og:title" content="Deep Analysis of Emotet Banking Trojan (TA542 APT)">
<meta property="og:url" content="http://localhost:4000/malware%20analysis/emotet/">


  <meta property="og:description" content="Emotet iss a banking Trojan designed to steal financial information from online banking sessions through man-in-the-browser (MITB) attacks, but since 2017 it has been observed distributing other malware families, such as IcedID, Zeus Panda and TrickBot. The malware has been actively developed, with each new version changing or extending its capabilities. ">



  <meta property="og:image" content="http://localhost:4000/assets/images/Malware-Analysis/Emotet/emotet.png">





  <meta property="article:published_time" content="2021-01-30T00:00:00+02:00">





  

  


<link rel="canonical" href="http://localhost:4000/malware%20analysis/emotet/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Omar Mohamed",
      "url": "http://localhost:4000/"
    
  }
</script>


  <meta name="google-site-verification" content="GkoI8ZebJ1mYszw7UZwRJaZTepJvXZOIhpTCZYaaMB" />





<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="ezi0x00 Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/SitePics/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/SitePics/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/SitePics/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          ezi0x00
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#malware-analysis">Malware Analysis</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/SitePics/avatar.png" alt="Omar Mohamed" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Omar Mohamed</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Cybersecurity Researcher</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Kingdom of Wisdom</span>
        </li>
      

      
        
          
            <li><a href="mailto:oabdellatifahmed@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
          
        
          
            <li><a href="https://www.linkedin.com/in/ezi0x00/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/ezi0x00" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Deep Analysis of Emotet Banking Trojan (TA542 APT)">
    <meta itemprop="description" content=" Emotet Live Cycle ">
    <meta itemprop="datePublished" content="2021-01-30T00:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Deep Analysis of Emotet Banking Trojan (TA542 APT)
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  9 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#-emotet-live-cycle-"> Emotet Live Cycle </a></li>
  <li><a href="#first-stage-microsoft-word-document-downloader">First Stage: Microsoft Word Document [Downloader]</a>
    <ul>
      <li><a href="#vba-analysis">VBA Analysis</a></li>
      <li><a href="#powershell-analysis">PowerShell Analysis</a></li>
    </ul>
  </li>
  <li><a href="#-second-stage-executable-file-"> Second Stage: Executable File </a>
    <ul>
      <li><a href="#static-analysis">Static Analysis</a></li>
      <li><a href="#behavioral-analysis">Behavioral Analysis</a></li>
      <li><a href="#binary-analysis">Binary Analysis</a></li>
    </ul>
  </li>
  <li><a href="#-third-stage-unpacked-executable-file-"> Third Stage: Unpacked Executable File </a></li>
  <li><a href="#-iocs-"> IOCs </a>
    <ul>
      <li><a href="#-hashes-md5-"> Hashes (MD5): </a></li>
      <li><a href="#-domains-requests-"> Domains Requests: </a></li>
      <li><a href="#-ips"> IPs</a></li>
    </ul>
  </li>
  <li><a href="#-references-"> References </a></li>
</ul>

            </nav>
          </aside>
        
        <h1 id="-emotet-live-cycle-"><u> Emotet Live Cycle </u></h1>

<p><a href="/assets/images/Malware-Analysis/Emotet/0.png"><img src="/assets/images/Malware-Analysis/Emotet/0.png" alt="0" /></a></p>

<h1 id="first-stage-microsoft-word-document-downloader"><u>First Stage: Microsoft Word Document [Downloader]</u></h1>

<table>
  <thead>
    <tr>
      <th>Fingerprint</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>MD5:</td>
      <td>57be28414e61ff58a6b52fc3c1b70b7f</td>
    </tr>
    <tr>
      <td>SHA-1:</td>
      <td>c4fbb54b194c1303897ac869811a274303d27f38</td>
    </tr>
    <tr>
      <td>SHA-256:</td>
      <td>01b1232dee4ac560ba34061aa65f5de79c7182de3b6f313ad1a83c39ce61550c</td>
    </tr>
    <tr>
      <td>File Type:</td>
      <td>Composite Document File V2 Document</td>
    </tr>
    <tr>
      <td>Create Time/Date:</td>
      <td>Fri Mar 15 16:04:00 2019</td>
    </tr>
  </tbody>
</table>

<p>The first stage of this malware is an microsoft Word formats (.doc) use VBA (Visual Basic for Applications) AutoOpen macros to execute code that downloads the Emotet loader. Emotet Word documents contain embedded images that request the user to click the <code class="language-plaintext highlighter-rouge">Enable Editing</code> button to disable Microsoft Word’s read-only mode (Protected View) and <code class="language-plaintext highlighter-rouge">Enable Content</code> to cause the macro to run.</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/1.png"><img src="/assets/images/Malware-Analysis/Emotet/1.png" alt="1" /></a></p>

<p>To view the macro click on Developer tab, click Visual Basic and you can see the macro.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/Malware-Analysis/Emotet/2.png"><img src="/assets/images/Malware-Analysis/Emotet/2.png" alt="2" /></a></td>
      <td><a href="/assets/images/Malware-Analysis/Emotet/3.png"><img src="/assets/images/Malware-Analysis/Emotet/3.png" alt="3" /></a></td>
    </tr>
  </tbody>
</table>

<h2 id="vba-analysis">VBA Analysis</h2>

<p>The documents contain obfuscated VBA code let’s analysis the most important parts in it</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/4.png"><img src="/assets/images/Malware-Analysis/Emotet/4.png" alt="4" /></a></p>

<p><code class="language-plaintext highlighter-rouge">autoopen()</code> function which gets executed when the document is opened</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/5.png"><img src="/assets/images/Malware-Analysis/Emotet/5.png" alt="5" /></a></p>

<p><code class="language-plaintext highlighter-rouge">powershell -e</code>
 first thing after execution the code creation of string by “powershell -e”.</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/6.png"><img src="/assets/images/Malware-Analysis/Emotet/6.png" alt="6" /></a></p>

<p><code class="language-plaintext highlighter-rouge">dBCWQQZ = winmgmts:Win32_Process</code>
 then variable dBCwQQZ is defined with the string “winmgmts:Win32_Process”.</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/7.png"><img src="/assets/images/Malware-Analysis/Emotet/7.png" alt="7" /></a></p>

<p><code class="language-plaintext highlighter-rouge">TCXD_U =GetObject(winmgmts:Win32_ProcessStartup)</code>
 then variable TCXD_U is defined with the string “GetObject(winmgmts:Win32_ProcessStartup)”.</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/8.png"><img src="/assets/images/Malware-Analysis/Emotet/8.png" alt="8" /></a></p>

<p><code class="language-plaintext highlighter-rouge">GetObject(winmgmts:Win32_ProcessStartup).ShowWindow = 0</code>
 then sets the parameter of “GetObject(winmgmts:Win32_ProcessStartup).ShowWindow” to a value of 0.</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/9.png"><img src="/assets/images/Malware-Analysis/Emotet/9.png" alt="9" /></a></p>

<p><code class="language-plaintext highlighter-rouge">jDD_UwDB = GetObject(winmgmts:Win32_Process).Create</code>
 Variable jDD_UwDB is defined with the string “GetObject(winmgmts:Win32_Process).Create”.</p>

<p>We can conclude from those parts the VBA code references Windows Management Instrumentation (WMI) classes winmgmts:Win32_ProcessStartup and winmgmts:Win32_Process. The macro uses WMI (Windows Management Instrumentation) to indirectly run PowerShell. The process is launched as a child process of WmiPrvSe.exe (WMI Provider Host).</p>

<h2 id="powershell-analysis">PowerShell Analysis</h2>

<p>extract powershell string:</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/10.png"><img src="/assets/images/Malware-Analysis/Emotet/10.png" alt="10" /></a></p>

<p>Base64 encoded, after decoded:</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/11.png"><img src="/assets/images/Malware-Analysis/Emotet/11.png" alt="11" /></a></p>

<p>After decoding the Base64 encoded string, the output illustrated in Figure is produced. The command is obfuscated using the same string joining and case mismatch techniques to evade detection. The decoded string contains many <code class="language-plaintext highlighter-rouge">+</code> characters that are used to concatenate strings, and a mixture of uppercase and lowercase characters. By removing all the <code class="language-plaintext highlighter-rouge">+</code> and <code class="language-plaintext highlighter-rouge">''</code> characters the deobfuscated command is revealed:</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/Malware-Analysis/Emotet/12.png"><img src="/assets/images/Malware-Analysis/Emotet/12.png" alt="12" /></a></td>
      <td><a href="/assets/images/Malware-Analysis/Emotet/13.png"><img src="/assets/images/Malware-Analysis/Emotet/12.png" alt="13" /></a></td>
    </tr>
  </tbody>
</table>

<p>The PowerShell command above compress and decodes another Base64 encoded string and reads it as a flow until it reaches the end of the chain. Then it runs the resulting output in memory using the <code class="language-plaintext highlighter-rouge">iex</code> alias of the Invoke-Expression cmdlet. This is a technique for executing commands in memory without saving files to disk. The command uses the variable <code class="language-plaintext highlighter-rouge">$Verbosepreference</code> which contains the string <code class="language-plaintext highlighter-rouge">SilentlyContinue</code>. The first and third characters (<code class="language-plaintext highlighter-rouge">i</code> and<code class="language-plaintext highlighter-rouge"> e</code>) are identified from the string, which are then joined by <code class="language-plaintext highlighter-rouge">X</code>, to form the text string<code class="language-plaintext highlighter-rouge"> ieX</code>.
The de obfuscated PowerShell script first splits the string assigned to the variable $XXQCZAxA using the “@” character as a delimiter and then enters a ForEach loop, which iterates the resulting array of URLs(hxxp://dautudatnenhoalac[.]com/wp-admin/DYAsI/)(hxxp://www.bewebpreneur[].]com/wp-admin/daHN/) to download the Emotet loader to the victim’s filesystem using the <code class="language-plaintext highlighter-rouge">Net.WebClient</code> class. The script uses the environment variable <code class="language-plaintext highlighter-rouge">$env:userProfile</code> to fetch the user profile directory of the currently logged-in user. The downloaded file is saved to the victim’s user profile directory <code class="language-plaintext highlighter-rouge">(typically C:\Users\[Username])</code> and set the file name with variable <code class="language-plaintext highlighter-rouge">TQQZoAGU</code> and this variable it equal 15 so the file will drop it called <code class="language-plaintext highlighter-rouge">15.exe</code></p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/Malware-Analysis/Emotet/14.png"><img src="/assets/images/Malware-Analysis/Emotet/14.png" alt="14" /></a></td>
      <td><a href="/assets/images/Malware-Analysis/Emotet/15.png"><img src="/assets/images/Malware-Analysis/Emotet/15.png" alt="15" /></a></td>
      <td><a href="/assets/images/Malware-Analysis/Emotet/16.png"><img src="/assets/images/Malware-Analysis/Emotet/16.png" alt="16" /></a></td>
    </tr>
  </tbody>
</table>

<p>As we can see when we run the command, it sends a HTTP GET request to retrieve the second-stage Emotet executable from (hxxp://dautudatnenhoalac[.]com/wp-admin/DYAsI). The response from the web server indicates that the file served is called s17zjCTuWfNF.exe and that the payload is a PE format file as indicated by the ASCII representation of the magic bytes 0x4D5A <code class="language-plaintext highlighter-rouge">MZ</code> at the start of the file.</p>

<p><code class="language-plaintext highlighter-rouge">Notice: The ForEach loop exits when check the file is large than 40 KB but when used fake net you will see the file is 2kb cause it's fake simulation. run the file to see real executable file</code></p>

<p><a href="/assets/images/Malware-Analysis/Emotet/17.png"><img src="/assets/images/Malware-Analysis/Emotet/17.png" alt="17" /></a></p>

<p>And here it is, as we mentioned before the macro uses WMI (Windows Management Instrumentation) to indirectly run PowerShell. The process is launched as a child process of WmiPrvSe.exe (WMI Provider Host).</p>

<h1 id="-second-stage-executable-file-"><u> Second Stage: Executable File </u></h1>

<table>
  <thead>
    <tr>
      <th>Fingerprint</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>MD5:</td>
      <td>322f9ca84dfa866cb719b7aecc249905</td>
    </tr>
    <tr>
      <td>SHA-1:</td>
      <td>147ddeb14bfcc1ff2ee7ef6470ca9a720e61aeaa</td>
    </tr>
    <tr>
      <td>SHA-256:</td>
      <td>af2f82adf716209cd5ba1c98d0dcd2d9a171bb0963648bd8bd962edb52761241</td>
    </tr>
    <tr>
      <td>File Type:</td>
      <td>PE32 executable (GUI) Intel 80386, for MS Windows</td>
    </tr>
    <tr>
      <td>File Size:</td>
      <td>428808 bytes</td>
    </tr>
    <tr>
      <td>Compiled:</td>
      <td>Fri Mar 15 19:49:00 2019</td>
    </tr>
  </tbody>
</table>

<h2 id="static-analysis">Static Analysis</h2>

<p><a href="/assets/images/Malware-Analysis/Emotet/18.png"><img src="/assets/images/Malware-Analysis/Emotet/18.png" alt="18" /></a></p>

<p>in sections, notice in the <code class="language-plaintext highlighter-rouge">.rsrc</code> (resource) the file in front of us occupies only 51% of the real file space, which means that the program is packed.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/Malware-Analysis/Emotet/19.png"><img src="/assets/images/Malware-Analysis/Emotet/19.png" alt="19" /></a></td>
      <td><a href="/assets/images/Malware-Analysis/Emotet/20.png"><img src="/assets/images/Malware-Analysis/Emotet/20.png" alt="20" /></a></td>
    </tr>
  </tbody>
</table>

<p>We notice in the resource label, there are two unfamiliar resources called EXCEPT and CALIBRATE, the <code class="language-plaintext highlighter-rouge">EXCEPT</code> have high entropy and large size This makes you think that it is encrypted payload. After dumbed the resource we notice there are encrypted data.</p>

<h2 id="behavioral-analysis">Behavioral Analysis</h2>

<p>First: After, downloading the emotet it lunches itself and first launcher lunches another instance from the same location(C:\Users[username]) as a child process and copied itself to <code class="language-plaintext highlighter-rouge">C:\Windows\SysWOW6</code> with different name, in my stat the name is <code class="language-plaintext highlighter-rouge">devneutral.exe</code></p>

<p><a href="/assets/images/Malware-Analysis/Emotet/21.png"><img src="/assets/images/Malware-Analysis/Emotet/21.png" alt="21" /></a></p>

<p>The process creates a service to indirectly launch the loader. In the call to <code class="language-plaintext highlighter-rouge">CreateService</code>, the BinaryPath points to <code class="language-plaintext highlighter-rouge">C:\Windows\SysWOW64\devneutral.exe</code> and the DesiredAccess is 18. This value grants <code class="language-plaintext highlighter-rouge">SERVICE_CHANGE_CONFIG</code> and <code class="language-plaintext highlighter-rouge">SERVICE_START</code> access permissions to the service.
And, create some libraries, read them as we can see:</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/22.png"><img src="/assets/images/Malware-Analysis/Emotet/22.png" alt="22" /></a></p>

<p>After, read the created libraries, we notice in threads and process activity it loaded it and their some interesting libraries like: <code class="language-plaintext highlighter-rouge">kernall32.dll - crypt32.dll - mswsock.dll - urlmon.dll</code>.</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/23.png"><img src="/assets/images/Malware-Analysis/Emotet/23.png" alt="23" /></a></p>

<p>And, here all registries it implementation with emotet and interesting one is <code class="language-plaintext highlighter-rouge">{aa5b6a80-b834-11d0-932f-00a0c90dcaa9}</code> which is passed as a parameter to <code class="language-plaintext highlighter-rouge">RegOpenKeyA</code>. This registry key is required for the Windows scripting engine interface</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/24.png"><img src="/assets/images/Malware-Analysis/Emotet/24.png" alt="24" /></a></p>

<p>After registering itself as service, <code class="language-plaintext highlighter-rouge">devneutral.exe</code> is launched by services.exe. and downloads the next stage payload from a remote server.
Then collects system information and sends it through an encrypted channel to its command and control (C2) servers in the data section of HTTP POST requests and receives further commands and payloads from the servers as a response. The loader also downloads modules to extend the functionality of the loader as well as other malware families.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/Malware-Analysis/Emotet/25.png"><img src="/assets/images/Malware-Analysis/Emotet/25.png" alt="25" /></a></td>
      <td><a href="/assets/images/Malware-Analysis/Emotet/26.png"><img src="/assets/images/Malware-Analysis/Emotet/26.png" alt="26" /></a></td>
    </tr>
  </tbody>
</table>

<p><code class="language-plaintext highlighter-rouge">Notice: Emotet sent encrypted C2 data as cookie values in the headers of HTTP GET requests.</code></p>

<h2 id="binary-analysis">Binary Analysis</h2>

<p>The <code class="language-plaintext highlighter-rouge">start</code> function that generates an array of characters and has a conditional while (true) infinite loop. The function works by reading a Windows Registry key through a call to <code class="language-plaintext highlighter-rouge">RegOpenKeyA</code>. If the key is not found, the malware enters an infinite loop</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/Malware-Analysis/Emotet/27.png"><img src="/assets/images/Malware-Analysis/Emotet/27.png" alt="27" /></a></td>
      <td><a href="/assets/images/Malware-Analysis/Emotet/28.png"><img src="/assets/images/Malware-Analysis/Emotet/28.png" alt="28" /></a></td>
    </tr>
  </tbody>
</table>

<p>The <code class="language-plaintext highlighter-rouge">sub_401A90</code> function  decodes a string with the value <code class="language-plaintext highlighter-rouge">interface\{aa5b6a80-b834-11d0-932f-00a0c90dcaa9}</code>(mentioned it before) which is passed as a parameter to <code class="language-plaintext highlighter-rouge">RegOpenKeyA</code></p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/Malware-Analysis/Emotet/29.png"><img src="/assets/images/Malware-Analysis/Emotet/29.png" alt="29" /></a></td>
      <td><a href="/assets/images/Malware-Analysis/Emotet/30.png"><img src="/assets/images/Malware-Analysis/Emotet/30.png" alt="30" /></a></td>
    </tr>
  </tbody>
</table>

<p>The important function, It sparked my attention is <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code>. This function is used to allocate memory in a remote process and is often used by emotet for process injection. We will start by putting a breakpoint on the return address for <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code>.</p>

<p>First: After, open <code class="language-plaintext highlighter-rouge">15.exe</code> in x32dbg go to <code class="language-plaintext highlighter-rouge">symbols</code>, search for <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>, but breakpoint on the address of function <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> and run.</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/32.png"><img src="/assets/images/Malware-Analysis/Emotet/32.png" alt="32" /></a></p>

<p>Then: but breakpoint on <code class="language-plaintext highlighter-rouge">ret</code> (return of function) and run.</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/33.png"><img src="/assets/images/Malware-Analysis/Emotet/33.png" alt="33" /></a></p>

<p>If we run until the breakpoint, we see that emotet creates an allocation of memory at <code class="language-plaintext highlighter-rouge">0x00011200</code>. It then copies a code stub from the .data section of the mapped image at 0x00470000 to the newly allocated memory space and gives control to it.</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/Malware-Analysis/Emotet/34.png"><img src="/assets/images/Malware-Analysis/Emotet/34.png" alt="34" /></a></td>
      <td><a href="/assets/images/Malware-Analysis/Emotet/35.png"><img src="/assets/images/Malware-Analysis/Emotet/35.png" alt="35" /></a></td>
    </tr>
  </tbody>
</table>

<p>Before breakpoint:</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/36.png"><img src="/assets/images/Malware-Analysis/Emotet/36.png" alt="36" /></a></p>

<p>Emotet then deobfuscates API and DLL names from the code copied to <code class="language-plaintext highlighter-rouge">0x00011200</code>, like <code class="language-plaintext highlighter-rouge">LoadLibraryExA</code>, <code class="language-plaintext highlighter-rouge">kernel32.dll</code> and <code class="language-plaintext highlighter-rouge">VirtualAlloc</code></p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/images/Malware-Analysis/Emotet/37.png"><img src="/assets/images/Malware-Analysis/Emotet/37.png" alt="37" /></a></td>
      <td><a href="/assets/images/Malware-Analysis/Emotet/38.png"><img src="/assets/images/Malware-Analysis/Emotet/38.png" alt="38" /></a></td>
    </tr>
  </tbody>
</table>

<p>It then calls <code class="language-plaintext highlighter-rouge">GetProcAddress</code> from <code class="language-plaintext highlighter-rouge">kernel32.dll</code> to get the addresses of the decoded API names.</p>

<p>The functions decoded:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LoadLibraryExA   
GetProcAddress
VirtualAlloc   
GetModuleHandleA
UnmapViewOfFile
WriteFile
SetFilePointer  
Sleep
LstrlenA   
LstrcatA   
VirtualProtect
CloseHandle   
VirtualFree   
GetTempPathA
CreateFileA
</code></pre></div></div>

<p>The emotet loader calls <code class="language-plaintext highlighter-rouge">GetProcAddress</code> for an invalid function name called <code class="language-plaintext highlighter-rouge">mknjht34tfserdgfwGetProcAddress</code>. Since this is invalid, the function returns a null value with an error code of <code class="language-plaintext highlighter-rouge">0000007F (ERROR_PROC_NOT_FOUND)</code>.</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/41.png"><img src="/assets/images/Malware-Analysis/Emotet/41.png" alt="41" /></a></p>

<p>Once the code stub has retrieved the function addresses, <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> is called to allocate another memory region where it writes the decrypted PE file from the .data section of 15.exe, rather than from the <code class="language-plaintext highlighter-rouge">.rsrc</code> section.</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/42.png"><img src="/assets/images/Malware-Analysis/Emotet/42.png" alt="42" /></a></p>

<h1 id="-third-stage-unpacked-executable-file-"><u> Third Stage: Unpacked Executable File </u></h1>

<table>
  <thead>
    <tr>
      <th>Fingerprint</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>MD5:</td>
      <td>D623BD93618B6BCA25AB259DE21E8E12</td>
    </tr>
    <tr>
      <td>SHA-1:</td>
      <td>BBE1BFC57E8279ADDF2183F8E29B90CFA6DD88B4</td>
    </tr>
    <tr>
      <td>SHA-256:</td>
      <td>01F86613FD39E5A3EDCF49B101154020A7A3382758F36D875B12A94294FBF0EA</td>
    </tr>
  </tbody>
</table>

<p>Dumping the executable and examining it reveals that it is another packed Emotet binary that contains the main loader.</p>

<p><a href="/assets/images/Malware-Analysis/Emotet/43.png"><img src="/assets/images/Malware-Analysis/Emotet/43.png" alt="43" /></a></p>

<p>After API name resolution, GetCurrentProcessId is called to get the process ID (PID) of Emotet‘s running process. Afterwards, Emotet iterates through all running processes to find its module name and parent PID. Once it finds its parent PID, it creates two mutexes with the format PEM%X. One of the mutexes is created using the parent process ID (PEM[PPID]) and the other uses its own PID (PEM[PID]).</p>

<p>After creating these mutexes, it calls CreateEventW to create an event using the format PEE%X, where %X is its parent PID. If both mutexes are successfully created, it launches 15.exe again from the same path. After launching the child process, it calls WaitForSingleObject on the PEE%X event.</p>

<p>We have seen in some of the Emotet samples that it launches child process with a command line switch. This command line switches are an indication that an Emotet process has been launched as a child process and has to perform a designated task.</p>

<p>The launched child process does everything same until it evaluates whether to create the two mutexes described above. This time the call to CreateMutex for mutex PEM[PPID] fails with the error “ERROR_ALREADY_EXISTS”. After the mutex creation fails in the child process, it signals the event PEE[PPID] to the parent process 15.exe. The parent process exits from a waiting state and then terminates itself.</p>

<h1 id="-iocs-"><u> IOCs </u></h1>

<h2 id="-hashes-md5-"><u> Hashes (MD5): </u></h2>

<p>First Stage: 57be28414e61ff58a6b52fc3c1b70b7f
Second Stage: 322f9ca84dfa866cb719b7aecc249905
Third Stage: D623BD93618B6BCA25AB259DE21E8E12</p>

<h2 id="-domains-requests-"><u> Domains Requests: </u></h2>

<p>hxxp://dautudatnenhoalac[.]com/wp-admin/DYAsI/
hxxp://www.bewebpreneur[.]com/wp-admin/daHN/
hxxp://82.78.228[.]57:443/free/tlb/</p>

<h2 id="-ips"><u> IPs</u></h2>

<p>103.237.145.132
192.241.233.63
82.78.228.57</p>

<h1 id="-references-"><u> References </u></h1>

<p>https://app.any.run/tasks/1879ad1f-ac52-4fba-9230-9cffee29e6cc
https://medium.com/swlh/static-analysis-of-the-emotet-malware-f94b16aa8f70
https://www.malwarebytes.com/emotet/
https://www.fortinet.com/blog/threat-research/deep-dive-into-emotet-malware
https://threatresearch.ext.hp.com/emotet-analysis-part-3/ and Part [1,2]</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#malware-analysis" class="page__taxonomy-item" rel="tag">Malware Analysis</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-01-30T00:00:00+02:00">January 30, 2021</time></p>
        
      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Omar Mohamed. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
